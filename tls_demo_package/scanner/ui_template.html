<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TLS & Security Scanner</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-900: #111827;
      color-scheme: light;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--gray-900);
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 32px 24px;
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.2);
    }
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .header-icon {
      font-size: 32px;
    }
    .header-title {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }
    .header-subtitle {
      margin: 4px 0 0 0;
      font-size: 14px;
      opacity: 0.9;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px 48px;
    }
    .layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 28px;
      align-items: start;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .message {
      background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
      border: 2px solid var(--primary);
      color: #075985;
      border-radius: 10px;
      padding: 14px 18px;
      margin-bottom: 24px;
      font-weight: 500;
    }
    .message.error {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border-color: var(--danger);
      color: #7f1d1d;
    }
    /* Form Styles */
    form {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      color: var(--gray-900);
    }
    label span.helper {
      font-size: 12px;
      font-weight: 400;
      color: var(--gray-600);
    }
    textarea {
      width: 100%;
      min-height: 180px;
      padding: 12px 14px;
      font-family: "Fira Code", "Courier New", monospace;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      resize: vertical;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    textarea::placeholder {
      color: var(--gray-300);
    }
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button.export-btn {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    button.export-btn:hover {
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    .export-panel {
      margin-top: 24px;
      padding: 18px;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border: 2px solid var(--success);
      border-radius: 10px;
      animation: slideUp 0.3s ease;
    }
    .export-panel h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #15803d;
    }
    .export-formats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 12px;
    }
    .export-formats label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 400;
      font-size: 14px;
      margin: 0;
      cursor: pointer;
    }
    .export-formats input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--success);
    }
    .hint {
      font-size: 13px;
      color: var(--gray-600);
      margin: 0;
    }
    /* Results Panel */
    .results-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }
    .results-header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }
    .result-stats {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .stat-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--gray-100);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }
    .result-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    details.result-item {
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      transition: all 0.2s ease;
    }
    details.result-item:hover {
      border-color: var(--primary);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.1);
    }
    details.result-item[open] {
      border-color: var(--primary);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.15);
    }
    .result-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
    }
    .result-summary:hover {
      background: var(--gray-50);
    }
    .result-summary h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      word-break: break-word;
      color: var(--gray-900);
    }
    .summary-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: var(--gray-100);
      color: var(--gray-700);
      white-space: nowrap;
    }
    .pill.low {
      background: #dbeafe;
      color: #075985;
    }
    .pill.warn {
      background: #fed7aa;
      color: #92400e;
    }
    .pill.danger {
      background: #fecaca;
      color: #7f1d1d;
    }
    .pill.success {
      background: #dcfce7;
      color: #15803d;
    }
    .result-body {
      padding: 0 20px 20px 20px;
      border-top: 1px solid var(--gray-200);
      display: grid;
      gap: 20px;
      animation: slideUp 0.3s ease;
    }
    .section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .section h3 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 700;
      color: var(--gray-700);
    }
    .section-divider {
      height: 1px;
      background: var(--gray-200);
      margin: 8px 0 0 0;
    }
    /* TLS Info */
    .tls-grid {
      display: grid;
      gap: 12px;
      font-size: 14px;
    }
    .tls-row {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 16px;
      align-items: start;
      padding: 10px 12px;
      background: var(--gray-50);
      border-radius: 6px;
    }
    .tls-label {
      font-weight: 600;
      color: var(--gray-700);
    }
    .tls-value {
      word-break: break-word;
      color: var(--gray-900);
      line-height: 1.5;
    }
    /* Headers Table */
    .header-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .header-table thead {
      background: var(--gray-50);
    }
    .header-table th {
      border: none;
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      color: var(--gray-700);
      background: var(--gray-50);
    }
    .header-table td {
      border-bottom: 1px solid var(--gray-200);
      padding: 10px 12px;
      word-break: break-word;
      color: var(--gray-900);
    }
    .header-table tr:last-child td {
      border-bottom: none;
    }
    /* Findings */
    .finding-list {
      display: grid;
      gap: 10px;
    }
    .finding-item {
      border-left: 4px solid;
      border-radius: 6px;
      padding: 12px 14px;
      font-size: 14px;
      line-height: 1.5;
    }
    .finding-item.high {
      border-left-color: #dc2626;
      background: #fef2f2;
      color: #7f1d1d;
    }
    .finding-item.medium {
      border-left-color: #f59e0b;
      background: #fffbeb;
      color: #78350f;
    }
    .finding-item.low {
      border-left-color: #3b82f6;
      background: #eff6ff;
      color: #1e3a8a;
    }
    .finding-item.info {
      border-left-color: #2563eb;
      background: #eff6ff;
      color: #1e3a8a;
    }
    .finding-item strong {
      font-weight: 600;
    }
    /* Suggestions */
    .suggestions {
      display: grid;
      gap: 10px;
    }
    .suggestion-item {
      border-left: 4px solid var(--primary);
      background: #eff6ff;
      padding: 12px 14px;
      border-radius: 6px;
      font-size: 14px;
      color: #1e3a8a;
      line-height: 1.5;
    }
    /* Code Block */
    .code-block {
      background: #0f172a;
      color: #e2e8f0;
      font-family: "Fira Code", "Courier New", monospace;
      border-radius: 8px;
      padding: 14px;
      max-height: 300px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .empty {
      color: var(--gray-600);
      font-size: 14px;
      padding: 20px;
      text-align: center;
      background: var(--gray-50);
      border-radius: 8px;
      margin: 0;
    }
    .placeholder {
      color: var(--gray-600);
      font-size: 16px;
      text-align: center;
      padding: 80px 40px;
    }
    .placeholder-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    /* Certificate Chain Styles */
    .cert-chain-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .cert-item {
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      overflow: hidden;
      background: white;
      transition: all 0.2s ease;
    }
    .cert-item:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
    }
    .cert-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      color: var(--primary);
    }
    .cert-header.expired {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
    }
    .cert-header.warning {
      background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
      color: #92400e;
    }
    .cert-index {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 12px;
      font-weight: 700;
      margin-right: 10px;
    }
    .cert-header.expired .cert-index {
      background: #991b1b;
    }
    .cert-header.warning .cert-index {
      background: #d97706;
    }
    .cert-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      font-size: 12px;
      transition: transform 0.2s ease;
    }
    .cert-item.open .cert-toggle {
      transform: rotate(90deg);
    }
    .cert-body {
      display: none;
      padding: 14px;
      border-top: 1px solid var(--gray-200);
      background: white;
      animation: slideDown 0.3s ease;
    }
    .cert-item.open .cert-body {
      display: block;
    }
    .cert-detail-grid {
      display: grid;
      gap: 10px;
      font-size: 13px;
    }
    .cert-detail-row {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 16px;
      padding: 8px 10px;
      background: var(--gray-50);
      border-radius: 4px;
    }
    .cert-detail-label {
      font-weight: 600;
      color: var(--gray-700);
    }
    .cert-detail-value {
      word-break: break-word;
      color: var(--gray-900);
      font-family: "Fira Code", monospace;
      font-size: 12px;
    }
    .cert-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .cert-badge {
      display: inline-block;
      padding: 4px 8px;
      background: var(--primary);
      color: white;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .chain-security-banner {
      padding: 12px 14px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }
    .chain-security-banner.secure {
      background: #dcfce7;
      color: #15803d;
      border-left: 4px solid #15803d;
    }
    .chain-security-banner.warning {
      background: #fef3c7;
      color: #92400e;
      border-left: 4px solid #f59e0b;
    }
    .chain-security-banner.critical {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid #dc2626;
    }
    .chain-security-banner.error {
      background: var(--gray-100);
      color: var(--gray-700);
      border-left: 4px solid var(--gray-400);
    }
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(37, 99, 235, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .auto-scan-indicator {
      display: inline-block;
      padding: 4px 8px;
      background: var(--success);
      color: white;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
    /* Expandable Content */
    .expandable-section {
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      overflow: hidden;
    }
    .expandable-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: var(--gray-50);
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      font-size: 13px;
      color: var(--gray-700);
      transition: background 0.2s ease;
    }
    .expandable-header:hover {
      background: var(--gray-100);
    }
    .expandable-header.open {
      background: #eff6ff;
      color: var(--primary);
    }
    .expandable-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    .expandable-toggle::before {
      content: '‚ñ∂';
      display: inline-block;
      transition: transform 0.2s ease;
      font-size: 10px;
    }
    .expandable-header.open .expandable-toggle::before {
      transform: rotate(90deg);
    }
    .expandable-content {
      display: none;
      padding: 14px;
      background: white;
    }
    .expandable-content.show {
      display: block;
      animation: slideDown 0.2s ease;
    }
    @keyframes slideDown {
      from {
        opacity: 0;
        max-height: 0;
      }
      to {
        opacity: 1;
        max-height: 2000px;
      }
    }
    .long-text {
      max-height: 300px;
      overflow-y: auto;
      padding: 12px;
      background: var(--gray-50);
      border-radius: 6px;
      font-family: "Fira Code", monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    /* Responsive */
    @media (max-width: 1200px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 768px) {
      .container {
        padding: 20px 16px 32px;
      }
      .header {
        padding: 24px 16px;
      }
      .header-content {
        flex-direction: column;
        text-align: center;
      }
      .layout {
        gap: 20px;
      }
      button {
        width: 100%;
      }
      .tls-row {
        grid-template-columns: 1fr;
      }
      .export-formats {
        grid-template-columns: 1fr;
      }
      .results-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-icon">üîí</div>
      <div>
        <h1 class="header-title">TLS & Security Scanner</h1>
        <p class="header-subtitle">Qu√©t c·∫•u h√¨nh b·∫£o m·∫≠t TLS/SSL v√† HTTP Headers</p>
      </div>
    </div>
  </div>
  <div class="container">
    {% if message %}
      <div class="message {% if 'error' in message|lower %}error{% endif %}">{{ message }}</div>
    {% endif %}
    <div class="layout">
      <section class="form-panel card">
        <form method="post" action="/scan">
          <label for="targets">
            Danh s√°ch domain ho·∫∑c URL
            <span class="helper">M·ªói domain/URL tr√™n m·ªôt d√≤ng</span>
          </label>
          <textarea id="targets" name="targets" placeholder="https://example.com:443&#10;https://github.com&#10;https://google.com">{{ targets_text }}</textarea>
          <p class="hint">üí° Nh·∫≠p danh s√°ch domain/URL ƒë·ªÉ qu√©t TLS v√† HTTP headers. H·ªó tr·ª£ IPv6, port t√πy ch·ªânh.</p>
          
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <input type="checkbox" id="auto-scan" checked style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
            <label for="auto-scan" style="margin: 0; cursor: pointer; font-weight: 400; font-size: 14px;">üöÄ T·ª± ƒë·ªông qu√©t khi nh·∫≠p URL</label>
          </div>

          <button type="submit" id="scan-btn">üîç Qu√©t c·∫•u h√¨nh</button>
        </form>
        
        {% if results %}
        <div class="export-panel">
          <h4>üìä Xu·∫•t b√°o c√°o</h4>
          <form method="post" action="/export" style="display: flex; flex-direction: column; gap: 12px;">
            <div class="export-formats">
              <label><input type="checkbox" name="formats" value="json" checked> JSON</label>
              <label><input type="checkbox" name="formats" value="csv" checked> CSV</label>
              <label><input type="checkbox" name="formats" value="html" checked> HTML</label>
              <label><input type="checkbox" name="formats" value="markdown" checked> Markdown</label>
            </div>
            <button type="submit" class="export-btn">‚¨áÔ∏è Xu·∫•t b√°o c√°o</button>
          </form>
        </div>
        {% endif %}
      </section>
      <section class="results-panel card">
        <div class="results-header">
          <h2>üìã K·∫øt qu·∫£ qu√©t</h2>
          {% if results %}
            <div class="result-stats">
              <div class="stat-badge">üìä T·ªïng c·ªông: {{ results|length }} domain</div>
              {% set risk_counts = {'HIGH': 0, 'MEDIUM': 0, 'LOW': 0} %}
              {% for item in results if not item.error %}
                {% if item.risk in risk_counts %}
                  {% set _ = risk_counts.update({item.risk: risk_counts[item.risk] + 1}) %}
                {% endif %}
              {% endfor %}
              {% if risk_counts.HIGH > 0 %}<div class="stat-badge" style="color: #b91c1c;">üî¥ Cao: {{ risk_counts.HIGH }}</div>{% endif %}
              {% if risk_counts.MEDIUM > 0 %}<div class="stat-badge" style="color: #d97706;">üü† Trung b√¨nh: {{ risk_counts.MEDIUM }}</div>{% endif %}
              {% if risk_counts.LOW > 0 %}<div class="stat-badge" style="color: #0284c7;">üîµ Th·∫•p: {{ risk_counts.LOW }}</div>{% endif %}
            </div>
          {% endif %}
        </div>
        {% if results %}
          <div class="result-list">
          {% for item in results %}
            <details class="result-item" {% if loop.first %}open{% endif %}>
              <summary class="result-summary">
                <h3>{{ item.url }}</h3>
                <div class="summary-meta">
                  {% if item.error %}
                    <span class="pill danger">‚ùå L·ªói</span>
                  {% else %}
                    <span class="pill">HTTP {{ item.status }}</span>
                    <span class="pill {{ 'danger' if item.risk == 'HIGH' else ('warn' if item.risk == 'MEDIUM' else ('low' if item.risk == 'LOW' else 'success')) }}">
                      {% if item.risk == 'HIGH' %}üî¥{% elif item.risk == 'MEDIUM' %}üü†{% elif item.risk == 'LOW' %}üîµ{% else %}‚úÖ{% endif %}
                      {{ item.risk }}
                    </span>
                  {% endif %}
                </div>
              </summary>
              <div class="result-body">
                {% if item.error %}
                  <p class="empty">‚ùå {{ item.error }}</p>
                {% else %}
                  <div class="section">
                    <h3>üîó Chu·ªói Ch·ª©ng Ch·ªâ</h3>
                    <div class="section-divider"></div>
                    {% if item.cert_chain.error %}
                      <p class="empty">‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y chu·ªói ch·ª©ng ch·ªâ: {{ item.cert_chain.error }}</p>
                    {% else %}
                      
                      {% if item.cert_chain.chain_length > 0 %}
                        <div style="padding: 12px; background: #f0f9ff; border-radius: 8px; margin-bottom: 12px; font-size: 12px; color: #0c4a6e;">
                          <strong>üîó Chu·ªói Ch·ª©ng Ch·ªâ:</strong>
                          {% for cert in item.cert_chain.chain %}
                            {% if cert.index == 0 %}
                              üçÉ Leaf (Server)
                            {% elif loop.last %}
                              {% if item.cert_chain.chain_length > 1 %} ‚Üí {% endif %}üîê Root CA
                            {% else %}
                              ‚Üí üîó Intermediate
                            {% endif %}
                          {% endfor %}

                        </div>
                      {% endif %}
                      
                      <div class="cert-chain-container">
                      {% for cert in item.cert_chain.chain %}
                        {% set cert_type = "Leaf" %}
                        {% if cert.is_self_signed %}
                          {% set cert_type = "Root CA" %}
                        {% elif cert.key_usage and "Certificate Sign" in cert.key_usage|string %}
                          {% set cert_type = "Intermediate CA" %}
                        {% endif %}
                        
                        <div class="cert-item {% if cert.days_remaining and cert.days_remaining < 0 %}open expired{% elif cert.days_remaining and cert.days_remaining < 30 %}open warning{% endif %}">
                          <div class="cert-header {% if cert.days_remaining and cert.days_remaining < 0 %}expired{% elif cert.days_remaining and cert.days_remaining < 30 %}warning{% endif %}">
                            <div style="display: flex; align-items: center; flex: 1; gap: 8px;">
                              <span class="cert-index">{{ cert.index + 1 }}</span>
                              <div style="display: flex; align-items: center; gap: 6px;">
                                {% if cert_type == "Leaf" %}
                                  <span style="display: inline-flex; align-items: center; justify-content: center; background: #dbeafe; color: #0c4a6e; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">üçÉ Server</span>
                                {% elif cert_type == "Intermediate CA" %}
                                  <span style="display: inline-flex; align-items: center; justify-content: center; background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">üîó Intermediate</span>
                                {% elif cert_type == "Root CA" %}
                                  <span style="display: inline-flex; align-items: center; justify-content: center; background: #dcfce7; color: #15803d; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">üîê Root CA</span>
                                {% endif %}
                              </div>
                              <div style="flex: 1;">
                                <div style="font-size: 13px;">{{ cert.subject }}</div>
                                <div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">
                                  Ph√°t h√†nh b·ªüi: <strong>{{ cert.issuer }}</strong>
                                  {% if cert.days_remaining %}
                                    <br/>
                                    {% if cert.days_remaining < 0 %}
                                      üî¥ H·∫øt h·∫°n {{ cert.days_remaining|abs }} ng√†y
                                    {% elif cert.days_remaining < 30 %}
                                      üü° C√≤n {{ cert.days_remaining }} ng√†y
                                    {% else %}
                                      üü¢ C√≤n hi·ªáu l·ª±c {{ cert.days_remaining }} ng√†y
                                    {% endif %}
                                  {% endif %}
                                </div>
                              </div>
                            </div>
                            <span class="cert-toggle">‚ñ∂</span>
                          </div>
                          <div class="cert-body">
                            <div class="cert-detail-grid">
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">Ph√°t h√†nh b·ªüi</span>
                                <span class="cert-detail-value">{{ cert.issuer }}</span>
                              </div>
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">Phi√™n b·∫£n</span>
                                <span class="cert-detail-value">{{ cert.version }}</span>
                              </div>
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">Serial</span>
                                <span class="cert-detail-value">{{ cert.serial_number }}</span>
                              </div>
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">T·ª≠ ng√†y</span>
                                <span class="cert-detail-value">{{ cert.not_before }}</span>
                              </div>
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">ƒê·∫øn ng√†y</span>
                                <span class="cert-detail-value">{{ cert.not_after }}</span>
                              </div>
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">Thu·∫≠t to√°n k√Ω</span>
                                <span class="cert-detail-value">{{ cert.signature_algorithm }}</span>
                              </div>
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">Kh√≥a c√¥ng khai</span>
                                <span class="cert-detail-value">{{ cert.public_key_type }} {{ cert.public_key_size }} bits</span>
                              </div>
                              {% if cert.subject_alt_names %}
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">SANs</span>
                                <span class="cert-detail-value">
                                  <div class="cert-list">
                                    {% for san in cert.subject_alt_names %}
                                      <span class="cert-badge">{{ san }}</span>
                                    {% endfor %}
                                  </div>
                                </span>
                              </div>
                              {% endif %}
                              {% if cert.key_usage %}
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">Key Usage</span>
                                <span class="cert-detail-value">
                                  <div class="cert-list">
                                    {% for usage in cert.key_usage %}
                                      <span class="cert-badge">{{ usage }}</span>
                                    {% endfor %}
                                  </div>
                                </span>
                              </div>
                              {% endif %}
                              {% if cert.extended_key_usage %}
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">EKU</span>
                                <span class="cert-detail-value">
                                  <div class="cert-list">
                                    {% for eku in cert.extended_key_usage %}
                                      <span class="cert-badge">{{ eku }}</span>
                                    {% endfor %}
                                  </div>
                                </span>
                              </div>
                              {% endif %}
                              {% if cert.is_ca %}
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">CA Info</span>
                                <span class="cert-detail-value">
                                  ‚úÖ Certificate Authority
                                  {% if cert.ca_path_length %}
                                    | Path Length: {{ cert.ca_path_length }}
                                  {% endif %}
                                </span>
                              </div>
                              {% endif %}
                              {% if cert.subject_key_identifier %}
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">Subject KID</span>
                                <span class="cert-detail-value" style="font-size: 11px; word-break: break-all;">{{ cert.subject_key_identifier }}</span>
                              </div>
                              {% endif %}
                              {% if cert.authority_key_identifier %}
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">Auth KID</span>
                                <span class="cert-detail-value" style="font-size: 11px; word-break: break-all;">{{ cert.authority_key_identifier }}</span>
                              </div>
                              {% endif %}
                              <div class="cert-detail-row">
                                <span class="cert-detail-label">SHA256</span>
                                <span class="cert-detail-value" style="font-size: 11px; word-break: break-all;">{{ cert.fingerprint_sha256 }}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                      </div>
                    {% endif %}
                  </div>

                  <div class="section">
                    <h3>üîê Th√¥ng tin TLS/SSL</h3>
                    <div class="section-divider"></div>
                    {% if item.tls.error %}
                      <p class="empty">‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y th√¥ng tin TLS: {{ item.tls.error }}</p>
                    {% else %}
                      <div class="tls-grid">
                        <div class="tls-row">
                          <span class="tls-label">Phi√™n b·∫£n</span>
                          <span class="tls-value"><strong>{{ item.tls.protocol }}</strong></span>
                        </div>
                        <div class="tls-row">
                          <span class="tls-label">Cipher Suite</span>
                          <span class="tls-value">{{ item.tls.cipher.name }} <br/><small style="color: #666;">({{ item.tls.cipher.bits }} bit, {{ item.tls.cipher.protocol }})</small></span>
                        </div>
                        {% if item.tls.certificate.subject %}
                          <div class="tls-row">
                            <span class="tls-label">Ch·ªß th·ªÉ</span>
                            <span class="tls-value">{{ item.tls.certificate.subject }}</span>
                          </div>
                        {% endif %}
                        {% if item.tls.certificate.issuer %}
                          <div class="tls-row">
                            <span class="tls-label">T·ªï ch·ª©c ph√°t h√†nh</span>
                            <span class="tls-value">{{ item.tls.certificate.issuer }}</span>
                          </div>
                        {% endif %}
                        {% if item.tls.certificate.not_before or item.tls.certificate.not_after %}
                          <div class="tls-row">
                            <span class="tls-label">Hi·ªáu l·ª±c</span>
                            <span class="tls-value">
                              {% if item.tls.certificate.not_before %}üìÖ T·ª´ {{ item.tls.certificate.not_before }}{% endif %}
                              {% if item.tls.certificate.not_after %}<br/>üìÖ ƒê·∫øn {{ item.tls.certificate.not_after }}{% endif %}
                            </span>
                          </div>
                        {% endif %}
                        {% if item.tls.certificate.serial_number %}
                          <div class="tls-row">
                            <span class="tls-label">Serial</span>
                            <span class="tls-value"><code>{{ item.tls.certificate.serial_number }}</code></span>
                          </div>
                        {% endif %}
                        {% if item.tls.certificate.subject_alt_names %}
                          <div class="tls-row">
                            <span class="tls-label">SANs</span>
                            <span class="tls-value">{{ item.tls.certificate.subject_alt_names }}</span>
                          </div>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                  <div class="section">
                    <h3>üì¶ HTTP Headers</h3>
                    <div class="section-divider"></div>
                    {% if item.headers %}
                      {% set header_count = item.headers|length %}
                      {% if header_count > 8 %}
                        <div class="expandable-section">
                          <div class="expandable-header" onclick="toggleExpand(this)">
                            <span>üìã Xem t·∫•t c·∫£ {{ header_count }} headers</span>
                            <span class="expandable-toggle"></span>
                          </div>
                          <div class="expandable-content">
                            <table class="header-table">
                              <thead>
                                <tr>
                                  <th>T√™n Header</th>
                                  <th>Gi√° tr·ªã</th>
                                </tr>
                              </thead>
                              <tbody>
                              {% for key, value in item.headers.items() %}
                                <tr>
                                  <th style="font-weight: 600; color: var(--primary);">{{ key }}</th>
                                  <td>{{ value }}</td>
                                </tr>
                              {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      {% else %}
                        <table class="header-table">
                          <thead>
                            <tr>
                              <th>T√™n Header</th>
                              <th>Gi√° tr·ªã</th>
                            </tr>
                          </thead>
                          <tbody>
                          {% for key, value in item.headers.items() %}
                            <tr>
                              <th style="font-weight: 600; color: var(--primary);">{{ key }}</th>
                              <td>
                                {% if value|length > 300 or '\n' in value or value.count(';') > 3 or value.count(',') > 5 %}
                                  <div class="expandable-section" style="margin: 0;">
                                    <div class="expandable-header" onclick="toggleExpand(this)" style="padding: 8px 10px;">
                                      <span style="font-size: 12px;">üìÑ Xem gi√° tr·ªã ({{ value|length }} k√Ω t·ª±)</span>
                                      <span class="expandable-toggle"></span>
                                    </div>
                                    <div class="expandable-content" style="padding: 10px;">
                                      <div class="long-text">{{ value }}</div>
                                    </div>
                                  </div>
                                {% else %}
                                  {{ value }}
                                {% endif %}
                              </td>
                            </tr>
                          {% endfor %}
                          </tbody>
                        </table>
                      {% endif %}
                    {% else %}
                      <p class="empty">‚ÑπÔ∏è Kh√¥ng nh·∫≠n ƒë∆∞·ª£c header ph·∫£n h·ªìi.</p>
                    {% endif %}
                  </div>
                  <div class="section">
                    <h3>üîç Ph√°t hi·ªán c·∫•u h√¨nh</h3>
                    <div class="section-divider"></div>
                    {% if item.findings %}
                      <div class="finding-list">
                        {% for finding in item.findings %}
                          <div class="finding-item {{ finding.severity|lower }}"><strong>{{ finding.severity }}</strong> ‚Äî {{ finding.rule }}: {{ finding.detail }}</div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <p class="empty">‚úÖ Kh√¥ng ghi nh·∫≠n v·∫•n ƒë·ªÅ b·∫£o m·∫≠t.</p>
                    {% endif %}
                  </div>
                  <div class="section">
                    <h3>üí° G·ª£i √Ω c·∫£i thi·ªán</h3>
                    <div class="section-divider"></div>
                    {% if item.suggestions %}
                      <div class="suggestions">
                        {% for suggestion in item.suggestions %}
                          <div class="suggestion-item">{{ suggestion }}</div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <p class="empty">üéâ C·∫•u h√¨nh hi·ªán t·∫°i t·ªëi ∆∞u, kh√¥ng c·∫ßn c·∫£i thi·ªán.</p>
                    {% endif %}
                  </div>

                {% endif %}
              </div>
            </details>
          {% endfor %}
          </div>
        {% else %}
          <div class="placeholder">
            <div class="placeholder-icon">üîç</div>
            <div><strong>B·∫Øt ƒë·∫ßu qu√©t b√¢y gi·ªù</strong></div>
            <div style="font-size: 14px; margin-top: 8px;">Nh·∫≠p domain ·ªü c·ªôt b√™n tr√°i v√† b·∫•m "Qu√©t c·∫•u h√¨nh"</div>
          </div>
        {% endif %}
      </section>
    </div>
  </div>
  <script>
    function toggleExpand(headerElement) {
      const content = headerElement.nextElementSibling;
      headerElement.classList.toggle('open');
      content.classList.toggle('show');
    }

    // Certificate chain expansion toggle
    function toggleCertItem(certElement) {
      certElement.classList.toggle('open');
    }

    // Auto-scan functionality
    document.addEventListener('DOMContentLoaded', function() {
      const targetsTextarea = document.getElementById('targets');
      const autoScanCheckbox = document.getElementById('auto-scan');
      const scanBtn = document.getElementById('scan-btn');
      let autoScanTimer = null;

      if (targetsTextarea && autoScanCheckbox && scanBtn) {
        targetsTextarea.addEventListener('input', function() {
          if (autoScanCheckbox.checked) {
            // Clear previous timer
            if (autoScanTimer) clearTimeout(autoScanTimer);
            
            // Debounce: wait 2 seconds after user stops typing
            autoScanTimer = setTimeout(function() {
              const text = targetsTextarea.value.trim();
              // Only auto-scan if there's content and it looks like valid URLs/domains
              if (text && (text.includes('.') || text.includes(':'))) {
                // Check if we have at least one valid-looking domain
                const lines = text.split('\n').filter(l => l.trim());
                const hasValidLine = lines.some(line => {
                  const trimmed = line.trim();
                  return trimmed.includes('.') || trimmed.includes('://') || trimmed.match(/^[a-z0-9-]+(:[0-9]+)?$/i);
                });
                
                if (hasValidLine) {
                  console.log('Auto-scanning...');
                  // Submit the form
                  const form = targetsTextarea.closest('form');
                  if (form) {
                    form.submit();
                  }
                }
              }
            }, 2000);
          }
        });

        // Attach cert item click handlers
        document.addEventListener('click', function(event) {
          const certHeader = event.target.closest('.cert-header');
          if (certHeader) {
            const certItem = certHeader.closest('.cert-item');
            if (certItem) {
              toggleCertItem(certItem);
            }
          }
        });
      }
    });
  </script>
</body>
</html>
